import React, { useState, useEffect } from 'react';
import { userService, doctorService, patientService } from '../services/userService';

export default function AdminDashboard() {
  const [activeTab, setActiveTab] = useState('overview');
  const [stats, setStats] = useState({
    totalUsers: 0,
    totalDoctors: 0,
    totalPatients: 0,
    activeSessions: 0,
    systemHealth: '99.9% Uptime',
    failedLogins: 0,
    userGrowth: '+1.5%',
    sessionChange: '-2.1%'
  });

  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [recentUsers, setRecentUsers] = useState([]);
  const [recentActivity, setRecentActivity] = useState([]);

  useEffect(() => {
    loadDashboardData();
  }, []);

  const loadDashboardData = async () => {
    try {
      setLoading(true);
      setError(null);

      const [usersResponse, doctorsResponse, patientsResponse] = await Promise.all([
        userService.getAll().catch(() => ({ data: [] })),
        doctorService.getAll().catch(() => ({ data: [] })),
        patientService.getAll().catch(() => ({ data: { patients: [] } }))
      ]);

      const users = usersResponse.data || [];
      const doctors = doctorsResponse.data?.data || doctorsResponse.data || [];
      const patients = patientsResponse.data?.data?.patients || patientsResponse.data?.patients || [];

      const activeSessions = Math.floor(users.length * 0.08);

      setStats({
        totalUsers: users.length,
        totalDoctors: doctors.length,
        totalPatients: patients.length,
        activeSessions: activeSessions,
        systemHealth: '99.9% Uptime',
        failedLogins: Math.floor(Math.random() * 10),
        userGrowth: '+1.5%',
        sessionChange: '-2.1%'
      });

      // Set recent users
      const sortedUsers = [...users].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      setRecentUsers(sortedUsers.slice(0, 5));

      // Mock recent activity
      setRecentActivity([
        { id: 1, action: 'New user registered', user: 'John Doe', time: '2 mins ago', type: 'success' },
        { id: 2, action: 'Appointment scheduled', user: 'Dr. Sarah', time: '5 mins ago', type: 'info' },
        { id: 3, action: 'Failed login attempt', user: 'Unknown', time: '10 mins ago', type: 'warning' },
        { id: 4, action: 'Profile updated', user: 'Jane Smith', time: '15 mins ago', type: 'info' },
        { id: 5, action: 'Password reset', user: 'Admin', time: '20 mins ago', type: 'success' }
      ]);

    } catch (err) {
      console.error('Dashboard error:', err);
      setError(err.message || 'Failed to load dashboard data');
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-[#1193d4] border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-slate-600 font-medium">Loading dashboard...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-center max-w-md">
          <div className="text-6xl mb-4">‚ö†Ô∏è</div>
          <h2 className="text-2xl font-bold text-slate-800 mb-2">Error Loading Dashboard</h2>
          <p className="text-slate-600 mb-4">{error}</p>
          <button 
            onClick={loadDashboardData}
            className="px-6 py-3 bg-[#1193d4] text-white rounded-lg hover:bg-[#0e7ab8] transition-colors font-medium"
          >
            Retry
          </button>
        </div>
      </div>
    );
  }

  const tabs = [
    { id: 'overview', name: 'Overview', icon: 'üìä' },
    { id: 'users', name: 'Users', icon: 'üë•' },
    { id: 'activity', name: 'Activity', icon: '‚ö°' },
    { id: 'analytics', name: 'Analytics', icon: 'üìà' }
  ];

  const getActivityColor = (type) => {
    switch (type) {
      case 'success': return 'bg-green-100 text-green-800 border-green-200';
      case 'warning': return 'bg-amber-100 text-amber-800 border-amber-200';
      case 'info': return 'bg-blue-100 text-blue-800 border-blue-200';
      default: return 'bg-slate-100 text-slate-800 border-slate-200';
    }
  };

  const getRoleBadgeColor = (role) => {
    switch (role) {
      case 'ADMIN': return 'bg-purple-100 text-purple-800';
      case 'DOCTOR': return 'bg-green-100 text-green-800';
      case 'PATIENT': return 'bg-blue-100 text-blue-800';
      default: return 'bg-slate-100 text-slate-800';
    }
  };

  return (
    <div className="p-10 bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 min-h-screen">
      {/* Page Heading with Tabs */}
      <div className="mb-8">
        <div className="flex flex-wrap justify-between items-start gap-4 mb-6">
          <div>
            <h1 className="text-4xl font-black text-slate-900 dark:text-white mb-2 bg-gradient-to-r from-[#1193d4] to-[#0e7ab8] bg-clip-text text-transparent">
              Welcome back, Evelyn! üëã
            </h1>
            <p className="text-base text-slate-600 dark:text-slate-400">
              Here's what's happening with your healthcare system today
            </p>
          </div>
          <button
            onClick={loadDashboardData}
            className="flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg hover:shadow-md transition-all"
          >
            <svg className="w-5 h-5 text-[#1193d4]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            <span className="text-sm font-medium text-slate-700 dark:text-slate-300">Refresh</span>
          </button>
        </div>

        {/* Interactive Tabs */}
        <div className="flex gap-2 border-b border-slate-200 dark:border-slate-700">
          {tabs.map((tab) => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`px-6 py-3 font-medium text-sm transition-all relative ${
                activeTab === tab.id
                  ? 'text-[#1193d4] border-b-2 border-[#1193d4]'
                  : 'text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white'
              }`}
            >
              <span className="flex items-center gap-2">
                <span>{tab.icon}</span>
                <span>{tab.name}</span>
              </span>
              {activeTab === tab.id && (
                <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-gradient-to-r from-[#1193d4] to-[#0e7ab8]"></div>
              )}
            </button>
          ))}
        </div>
      </div>

      {/* Stats Cards - Always Visible */}
      <div className="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4 mb-8">
        {/* Total Users Card */}
        <div className="group relative overflow-hidden rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 p-6 text-white shadow-lg hover:shadow-2xl transition-all duration-300 hover:-translate-y-1 cursor-pointer">
          <div className="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-12 -mt-12"></div>
          <div className="relative">
            <div className="flex items-center justify-between mb-4">
              <div className="p-3 bg-white/20 backdrop-blur-sm rounded-lg">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
              </div>
              <span className="text-xs font-semibold px-2 py-1 bg-white/20 rounded-full">Total</span>
            </div>
            <p className="text-sm font-medium opacity-90 mb-1">Total Users</p>
            <p className="text-3xl font-bold mb-2">{stats.totalUsers}</p>
            <div className="flex items-center gap-1 text-sm">
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
              </svg>
              <span className="font-semibold">{stats.userGrowth}</span>
              <span className="opacity-75">this month</span>
            </div>
          </div>
        </div>

        {/* Active Sessions Card */}
        <div className="group relative overflow-hidden rounded-xl bg-gradient-to-br from-emerald-500 to-green-600 p-6 text-white shadow-lg hover:shadow-2xl transition-all duration-300 hover:-translate-y-1 cursor-pointer">
          <div className="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-12 -mt-12"></div>
          <div className="relative">
            <div className="flex items-center justify-between mb-4">
              <div className="p-3 bg-white/20 backdrop-blur-sm rounded-lg">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <span className="text-xs font-semibold px-2 py-1 bg-white/20 rounded-full">Live</span>
            </div>
            <p className="text-sm font-medium opacity-90 mb-1">Active Sessions</p>
            <p className="text-3xl font-bold mb-2">{stats.activeSessions}</p>
            <div className="flex items-center gap-1 text-sm">
              <span className="relative flex h-2 w-2">
                <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-75"></span>
                <span className="relative inline-flex rounded-full h-2 w-2 bg-white"></span>
              </span>
              <span className="font-semibold">Active now</span>
            </div>
          </div>
        </div>

        {/* System Health Card */}
        <div className="group relative overflow-hidden rounded-xl bg-gradient-to-br from-purple-500 to-indigo-600 p-6 text-white shadow-lg hover:shadow-2xl transition-all duration-300 hover:-translate-y-1 cursor-pointer">
          <div className="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-12 -mt-12"></div>
          <div className="relative">
            <div className="flex items-center justify-between mb-4">
              <div className="p-3 bg-white/20 backdrop-blur-sm rounded-lg">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
              </div>
              <span className="text-xs font-semibold px-2 py-1 bg-white/20 rounded-full">Healthy</span>
            </div>
            <p className="text-sm font-medium opacity-90 mb-1">System Health</p>
            <p className="text-3xl font-bold mb-2">{stats.systemHealth}</p>
            <div className="flex items-center gap-1 text-sm">
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span className="font-semibold">All systems operational</span>
            </div>
          </div>
        </div>

        {/* Failed Logins Card */}
        <div className="group relative overflow-hidden rounded-xl bg-gradient-to-br from-amber-500 to-orange-600 p-6 text-white shadow-lg hover:shadow-2xl transition-all duration-300 hover:-translate-y-1 cursor-pointer">
          <div className="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-12 -mt-12"></div>
          <div className="relative">
            <div className="flex items-center justify-between mb-4">
              <div className="p-3 bg-white/20 backdrop-blur-sm rounded-lg">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
              </div>
              <span className="text-xs font-semibold px-2 py-1 bg-white/20 rounded-full">24h</span>
            </div>
            <p className="text-sm font-medium opacity-90 mb-1">Failed Logins</p>
            <p className="text-3xl font-bold mb-2">{stats.failedLogins}</p>
            <div className="flex items-center gap-1 text-sm">
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span className="font-semibold">Low risk</span>
            </div>
          </div>
        </div>
      </div>

      {/* Tab Content */}
      {activeTab === 'overview' && (
        <div className="space-y-6">
          {/* Charts Row */}
          <div className="grid grid-cols-1 gap-6 lg:grid-cols-5">
        {/* User Activity Chart */}
        <div className="flex flex-col gap-2 rounded-xl border border-slate-200 bg-white p-6 dark:border-slate-800 dark:bg-slate-900 lg:col-span-3">
          <p className="text-base font-medium leading-normal text-slate-900 dark:text-white">
            User Activity (Last 7 Days)
          </p>
          <p className="truncate text-3xl font-bold leading-tight tracking-tight text-slate-900 dark:text-white">
            3,450 Actions
          </p>
          <div className="flex gap-1">
            <p className="text-base font-normal leading-normal text-slate-500 dark:text-slate-400">
              Last 7 Days
            </p>
            <p className="text-base font-medium leading-normal text-green-600">
              +5.2%
            </p>
          </div>
          <div className="flex min-h-[220px] flex-1 flex-col gap-8 py-4">
            <svg fill="none" height="100%" preserveAspectRatio="none" viewBox="-3 0 478 150" width="100%" xmlns="http://www.w3.org/2000/svg">
              <path d="M0 109C18.1538 109 18.1538 21 36.3077 21C54.4615 21 54.4615 41 72.6154 41C90.7692 41 90.7692 93 108.923 93C127.077 93 127.077 33 145.231 33C163.385 33 163.385 101 181.538 101C199.692 101 199.692 61 217.846 61C236 61 236 45 254.154 45C272.308 45 272.308 121 290.462 121C308.615 121 308.615 149 326.769 149C344.923 149 344.923 1 363.077 1C381.231 1 381.231 81 399.385 81C417.538 81 417.538 129 435.692 129C453.846 129 453.846 25 472 25V149H326.769H0V109Z" fill="url(#paint0_linear_chart)"></path>
              <path className="text-[#1193d4]" d="M0 109C18.1538 109 18.1538 21 36.3077 21C54.4615 21 54.4615 41 72.6154 41C90.7692 41 90.7692 93 108.923 93C127.077 93 127.077 33 145.231 33C163.385 33 163.385 101 181.538 101C199.692 101 199.692 61 217.846 61C236 61 236 45 254.154 45C272.308 45 272.308 121 290.462 121C308.615 121 308.615 149 326.769 149C344.923 149 344.923 1 363.077 1C381.231 1 381.231 81 399.385 81C417.538 81 417.538 129 435.692 129C453.846 129 453.846 25 472 25" stroke="currentColor" strokeLinecap="round" strokeWidth="3"></path>
              <defs>
                <linearGradient gradientUnits="userSpaceOnUse" id="paint0_linear_chart" x1="236" x2="236" y1="1" y2="149">
                  <stop className="text-[#1193d4]/30 dark:text-[#1193d4]/20" stopColor="currentColor"></stop>
                  <stop className="text-[#1193d4]/0" offset="1" stopColor="currentColor" stopOpacity="0"></stop>
                </linearGradient>
              </defs>
            </svg>
            <div className="flex justify-around">
              <p className="text-[13px] font-bold leading-normal tracking-[0.015em] text-slate-500 dark:text-slate-400">Mon</p>
              <p className="text-[13px] font-bold leading-normal tracking-[0.015em] text-slate-500 dark:text-slate-400">Tue</p>
              <p className="text-[13px] font-bold leading-normal tracking-[0.015em] text-slate-500 dark:text-slate-400">Wed</p>
              <p className="text-[13px] font-bold leading-normal tracking-[0.015em] text-slate-500 dark:text-slate-400">Thu</p>
              <p className="text-[13px] font-bold leading-normal tracking-[0.015em] text-slate-500 dark:text-slate-400">Fri</p>
              <p className="text-[13px] font-bold leading-normal tracking-[0.015em] text-slate-500 dark:text-slate-400">Sat</p>
              <p className="text-[13px] font-bold leading-normal tracking-[0.015em] text-slate-500 dark:text-slate-400">Sun</p>
            </div>
          </div>
        </div>

        {/* User Distribution Chart */}
        <div className="flex flex-col gap-2 rounded-xl border border-slate-200 bg-white p-6 dark:border-slate-800 dark:bg-slate-900 lg:col-span-2">
          <p className="text-base font-medium leading-normal text-slate-900 dark:text-white">
            User Role Distribution
          </p>
          <p className="truncate text-3xl font-bold leading-tight tracking-tight text-slate-900 dark:text-white">
            {stats.totalUsers} Total Users
          </p>
          <div className="flex gap-1">
            <p className="text-base font-normal leading-normal text-slate-500 dark:text-slate-400">
              All Time
            </p>
            <p className="text-base font-medium leading-normal text-green-600">
              {stats.userGrowth}
            </p>
          </div>
          <div className="flex h-full min-h-[220px] flex-1 items-center justify-center py-4">
            <div className="relative flex h-48 w-48 items-center justify-center">
              <svg className="h-full w-full -rotate-90 transform" viewBox="0 0 36 36">
                <circle className="stroke-current text-slate-200 dark:text-slate-700" cx="18" cy="18" fill="transparent" r="15.9154943092" strokeWidth="3"></circle>
                <circle className="stroke-current text-[#1193d4]" cx="18" cy="18" fill="transparent" r="15.9154943092" strokeDasharray="60 100" strokeDashoffset="0" strokeWidth="3"></circle>
                <circle className="stroke-current text-teal-500" cx="18" cy="18" fill="transparent" r="15.9154943092" strokeDasharray="30 100" strokeDashoffset="-60" strokeWidth="3"></circle>
                <circle className="stroke-current text-amber-500" cx="18" cy="18" fill="transparent" r="15.9154943092" strokeDasharray="10 100" strokeDashoffset="-90" strokeWidth="3"></circle>
              </svg>
              <div className="absolute flex flex-col items-center justify-center">
                <span className="text-2xl font-bold text-slate-900 dark:text-white">{stats.totalUsers}</span>
                <span className="text-sm text-slate-500 dark:text-slate-400">Users</span>
              </div>
            </div>
          </div>
          <div className="grid grid-cols-3 gap-2 text-center">
            <div>
              <div className="flex items-center justify-center gap-2">
                <div className="h-2 w-2 rounded-full bg-[#1193d4]"></div>
                <p className="text-xs font-medium text-slate-600 dark:text-slate-400">Patients (60%)</p>
              </div>
            </div>
            <div>
              <div className="flex items-center justify-center gap-2">
                <div className="h-2 w-2 rounded-full bg-teal-500"></div>
                <p className="text-xs font-medium text-slate-600 dark:text-slate-400">Clinicians (30%)</p>
              </div>
            </div>
            <div>
              <div className="flex items-center justify-center gap-2">
                <div className="h-2 w-2 rounded-full bg-amber-500"></div>
                <p className="text-xs font-medium text-slate-600 dark:text-slate-400">Admins (10%)</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Quick Actions */}
      <div className="mt-8 flex flex-col rounded-xl border border-slate-200 bg-white p-6 dark:border-slate-800 dark:bg-slate-900">
        <h3 className="text-lg font-bold text-slate-900 dark:text-white">Quick Actions</h3>
        <p className="text-sm text-slate-500 dark:text-slate-400">Quickly access common administrative tasks.</p>
        <div className="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
          <button className="flex items-center gap-3 rounded-lg bg-slate-100 p-4 text-left text-slate-700 hover:bg-slate-200 dark:bg-slate-800 dark:text-slate-300 dark:hover:bg-slate-700">
            <div className="rounded-lg bg-[#1193d4]/20 p-2 text-[#1193d4]">
              <svg className="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
              </svg>
            </div>
            <div>
              <p className="font-semibold">Add New User</p>
              <p className="text-xs text-slate-500 dark:text-slate-400">Onboard a new patient, clinician, or admin.</p>
            </div>
          </button>

          <button className="flex items-center gap-3 rounded-lg bg-slate-100 p-4 text-left text-slate-700 hover:bg-slate-200 dark:bg-slate-800 dark:text-slate-300 dark:hover:bg-slate-700">
            <div className="rounded-lg bg-[#1193d4]/20 p-2 text-[#1193d4]">
              <svg className="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
            </div>
            <div>
              <p className="font-semibold">View Latest Audit Logs</p>
              <p className="text-xs text-slate-500 dark:text-slate-400">Review recent system and user activities.</p>
            </div>
          </button>

          <button className="flex items-center gap-3 rounded-lg bg-slate-100 p-4 text-left text-slate-700 hover:bg-slate-200 dark:bg-slate-800 dark:text-slate-300 dark:hover:bg-slate-700">
            <div className="rounded-lg bg-[#1193d4]/20 p-2 text-[#1193d4]">
              <svg className="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
            </div>
            <div>
              <p className="font-semibold">Initiate Password Resets</p>
              <p className="text-xs text-slate-500 dark:text-slate-400">Help users who are locked out of their accounts.</p>
            </div>
          </button>
        </div>
      </div>
    </div>
  );
}
